<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 从零打造装饰器风格的NodeJs路由器 · Leo's Blog</title><meta name="description" content="从零打造装饰器风格的NodeJs路由器 - Tauleos"><meta name="google-site-verification" content="y-sRxe2Toq8nFRU8PiEYywkdUoWdk_UYysZDKbnM7Ck"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://tauleos.github.io/atom.xml" title="Leo's Blog"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Leo's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAGS</a></li><li class="nav-list-item"><a href="https://github.com/Tauleos" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">从零打造装饰器风格的NodeJs路由器</h1><div class="post-info">2022年3月10日</div><div class="post-content"><blockquote>
<p>本文章默认听众使用Koa框架。</p>
</blockquote>
<p>在我们使用nodejs开发项目的时候，如果项目中有很多路由，那么我们需要写很多的类似<code>router.get(&#39;xxx&#39;, () =&gt; &#123;&#125;)</code>这样的代码。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"><span class="keyword">var</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line">router</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;Hello World!&#x27;</span>;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">post</span>(<span class="string">&#x27;/users&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">put</span>(<span class="string">&#x27;/users/:id&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>熟悉<code>Java</code>的朋友应该都知道， 可以通过以下形式定义路由</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HomeController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/list&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/update&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样不仅简化、规范化了路由的写法，减少了代码的冗余和错误，还使代码含义一目了然，无需注释也能通俗易懂。那么<code>Java</code>中的注解功能对应到<code>NodeJs</code>，分别是一下两种工具：<strong>装饰器与元编程</strong>。我们是不是也可以通过装饰器来达到我们的目的呢?首先让我们先来了解一下他们。</p>
<h2 id="Decorator-装饰器"><a href="#Decorator-装饰器" class="headerlink" title="Decorator(装饰器)"></a>Decorator(装饰器)</h2><p>装饰器提供了一种为类声明和成员添加注释和元编程语法的方法。装饰器是<code>JavaScript</code>的<a target="_blank" rel="noopener" href="https://github.com/tc39/proposal-decorators">stage-2 proposal</a>，可作为 <code>TypeScript</code> 的实验性功能使用。</p>
<blockquote>
<p>注意装饰器是一项实验性功能，可能会在未来版本中更改。</p>
</blockquote>
<p>要启用对装饰器的实验性支持，必须要在<code>tsconfig.json</code>中配置打开<code>experimentalDecorators</code>这个编译属性<br><img src="/images/decorator/ts-definition.png"></p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">TypedPropertyDescriptor</span>&lt;T&gt; &#123;</span><br><span class="line">    enumerable?: <span class="built_in">boolean</span>;</span><br><span class="line">    configurable?: <span class="built_in">boolean</span>;</span><br><span class="line">    writable?: <span class="built_in">boolean</span>;</span><br><span class="line">    value?: T;</span><br><span class="line">    get?: <span class="function">() =&gt;</span> T;</span><br><span class="line">    set?: <span class="function">(<span class="params"><span class="attr">value</span>: T</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">ClassDecorator</span> = &lt;<span class="title class_">TFunction</span> <span class="keyword">extends</span> <span class="title class_">Function</span>&gt;<span class="function">(<span class="params"><span class="attr">target</span>: <span class="title class_">TFunction</span></span>) =&gt;</span> <span class="title class_">TFunction</span> | <span class="built_in">void</span>;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">PropertyDecorator</span> = <span class="function">(<span class="params"><span class="attr">target</span>: <span class="title class_">Object</span>, <span class="attr">propertyKey</span>: <span class="built_in">string</span> | <span class="built_in">symbol</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">MethodDecorator</span> = &lt;T&gt;<span class="function">(<span class="params"><span class="attr">target</span>: <span class="title class_">Object</span>, <span class="attr">propertyKey</span>: <span class="built_in">string</span> | <span class="built_in">symbol</span>, <span class="attr">descriptor</span>: <span class="title class_">TypedPropertyDescriptor</span>&lt;T&gt;</span>) =&gt;</span> <span class="title class_">TypedPropertyDescriptor</span>&lt;T&gt; | <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">ParameterDecorator</span> = <span class="function">(<span class="params"><span class="attr">target</span>: <span class="title class_">Object</span>, <span class="attr">propertyKey</span>: <span class="built_in">string</span> | <span class="built_in">symbol</span>, <span class="attr">parameterIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure>

<h3 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h3><ol>
<li>不同类型的装饰器的执行顺序是明确定义的：</li>
<li>实例成员:    参数装饰器 -&gt; 方法 / 访问器 / 属性 装饰器</li>
<li>静态成员:    参数装饰器 -&gt; 方法 / 访问器 / 属性 装饰器</li>
<li>构造器:        参数装饰器</li>
<li>类装饰器</li>
<li>同一方法中不同参数的装饰器的执行顺序是相反的， <strong>最后一个参数的装饰器会最先被执行</strong></li>
<li>多个装饰器组合应用，他们的执行顺序是<strong>由上到下编译，由下到上执行（FILO）,可以当做栈来理解</strong></li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">key: string</span>): any &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;evaluate: &quot;</span>, key);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;call: &quot;</span>, key);</span><br><span class="line">  &#125;;&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_">f</span>(<span class="string">&quot;Class Decorator&quot;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line">  @<span class="title function_">f</span>(<span class="string">&quot;Static Property&quot;</span>)</span><br><span class="line">  <span class="keyword">static</span> prop?: number;</span><br><span class="line"></span><br><span class="line">  @<span class="title function_">f</span>(<span class="string">&quot;Static Method&quot;</span>)</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">method</span>(<span class="params">@f(<span class="string">&quot;Static Method Parameter&quot;</span>) foo</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">@f(<span class="string">&quot;Constructor Parameter&quot;</span>) foo</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  @<span class="title function_">f</span>(<span class="string">&quot;Instance Method&quot;</span>)</span><br><span class="line">  <span class="title function_">method</span>(<span class="params">@f(<span class="string">&quot;Instance Method Parameter&quot;</span>) foo</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  @<span class="title function_">f</span>(<span class="string">&quot;Instance Property&quot;</span>)</span><br><span class="line">  prop?: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="reflect-metadata-元数据"><a href="#reflect-metadata-元数据" class="headerlink" title="reflect-metadata(元数据)"></a><a target="_blank" rel="noopener" href="https://github.com/rbuckton/reflect-metadata">reflect-metadata</a>(元数据)</h2><blockquote>
<p>严格地说，元数据和装饰器是<code>EcmaScript</code>中两个独立的部分。 然而，如果你想实现像是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8F%8D%E5%B0%84_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">反射</a>这样的能力，你总是同时需要它们。<br>有了<code>reflect-metadata</code>的帮助， 我们可以获取编译期的类型。</p>
</blockquote>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><code>Reflect Metadata</code> 是 ES7 的一个提案（stage-2），它主要用来在声明的时候添加和读取元数据。<code>TypeScript</code> 在 1.5+ 的版本已经支持它，你只需要：</p>
<ul>
<li><code>npm i reflect-metadata --save</code></li>
<li>在 <code>tsconfig.json</code> 里配置 <code>emitDecoratorMetadata</code> 选项。</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">@<span class="title class_">Reflect</span>.<span class="title function_">metadata</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;A&#x27;</span>)<span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  @<span class="title class_">Reflect</span>.<span class="title function_">metadata</span>(<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>)</span><br><span class="line">  public <span class="title function_">hello</span>(): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;name&#x27;</span>, A) <span class="comment">// &#x27;A&#x27;</span></span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;hello&#x27;</span>, <span class="keyword">new</span> <span class="title function_">A</span>()) <span class="comment">// &#x27;world&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// define metadata on an object or property</span></span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">defineMetadata</span>(metadataKey, metadataValue, target);</span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">defineMetadata</span>(metadataKey, metadataValue, target, propertyKey);</span><br><span class="line"><span class="comment">// check for presence of a metadata key on the prototype chain of an object or property</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">hasMetadata</span>(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">hasMetadata</span>(metadataKey, target, propertyKey);</span><br><span class="line"><span class="comment">// check for presence of an own metadata key of an object or property</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">hasOwnMetadata</span>(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">hasOwnMetadata</span>(metadataKey, target, propertyKey);</span><br><span class="line"><span class="comment">// get metadata value of a metadata key on the prototype chain of an object or property</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(metadataKey, target, propertyKey);</span><br><span class="line"><span class="comment">// get metadata value of an own metadata key of an object or property</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">getOwnMetadata</span>(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">getOwnMetadata</span>(metadataKey, target, propertyKey);</span><br><span class="line"><span class="comment">// get all metadata keys on the prototype chain of an object or property</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">getMetadataKeys</span>(target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">getMetadataKeys</span>(target, propertyKey);</span><br><span class="line"><span class="comment">// get all own metadata keys of an object or property</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">getOwnMetadataKeys</span>(target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">getOwnMetadataKeys</span>(target, propertyKey);</span><br><span class="line"><span class="comment">// delete metadata from an object or property</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">deleteMetadata</span>(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="title class_">Reflect</span>.<span class="title function_">deleteMetadata</span>(metadataKey, target, propertyKey);</span><br><span class="line"><span class="comment">// apply metadata via a decorator to a constructor</span></span><br><span class="line">@<span class="title class_">Reflect</span>.<span class="title function_">metadata</span>(metadataKey, metadataValue)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line">  <span class="comment">// apply metadata via a decorator to a method (property)</span></span><br><span class="line">  @<span class="title class_">Reflect</span>.<span class="title function_">metadata</span>(metadataKey, metadataValue)</span><br><span class="line">  <span class="title function_">method</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="如何用装饰器打造路由？"><a href="#如何用装饰器打造路由？" class="headerlink" title="如何用装饰器打造路由？"></a>如何用装饰器打造路由？</h2><p><img src="/images/decorator/effects.png"></p>
<ol>
<li>提供需要注册的装饰器,通过<code>metadata</code>存储对应的数据信息。 </li>
<li>类装饰器：<code>@Controller()</code><br><img src="/images/decorator/controller.png"></li>
<li>方法装饰器：<code>@Get()、@Post()、@Put()、@Delete()</code><br><img src="/images/decorator/method.png"></li>
<li>参数装饰器：<code>@Request()、@Response()、@Ctx()、@Body()、@Param()、@Session()</code>等等。<br><img src="/images/decorator/param.png"></li>
<li>创建一个依赖注入的容器，收集所有与路由相关的配置，并进行路由注册。</li>
<li>遍历文件夹中所有符合条件的Controller文件，并获取相应的Controller类<br><img src="/images/decorator/scan.png"></li>
<li>扫描每个Controller类的实例方法，检测是否需要路由注册，并根据metadata中的数据进行路由的组装与注册<br><img src="/images/decorator/register.png"></li>
<li>绑定Controller实例方法到KoaRouter中，并注入相关参数。<br><img src="/images/decorator/callback.png"></li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>在项目启动阶段，会创建一个依赖注入容器（<code>Container</code>），扫描所有用户代码（<code>Controller</code>）中的文件，将拥有<code>@Controller</code>装饰器的 <code>Class</code>，保存到容器中。</li>
<li>这里的依赖注入容器内部维护了一个数组。用来存放类本身。</li>
<li>在扫描时，会动态实例化这些 Class，并且绑定属性方法（参数）与路由的动态关系，并且注册到router中</li>
</ul>
<p>以上就是路由器注入的核心过程。</p>
<h2 id="场景扩展"><a href="#场景扩展" class="headerlink" title="场景扩展"></a>场景扩展</h2><ul>
<li>Before/After钩子。</li>
<li>监听属性改变或者方法调用。</li>
<li>对方法的参数做转换。</li>
<li>添加额外的方法和属性。</li>
<li>运行时类型检查。</li>
<li>依赖注入（dependency injection）</li>
</ul>
<p>参考资料</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/decorators.html#introduction">https://www.typescriptlang.org/docs/handbook/decorators.html#introduction</a></li>
<li><a target="_blank" rel="noopener" href="https://saul-mirone.github.io/a-complete-guide-to-typescript-decorator">https://saul-mirone.github.io/a-complete-guide-to-typescript-decorator</a></li>
<li><a target="_blank" rel="noopener" href="https://rbuckton.github.io/reflect-metadata/">https://rbuckton.github.io/reflect-metadata/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/seanpmaxwell/overnight">https://github.com/seanpmaxwell/overnight</a></li>
<li><a target="_blank" rel="noopener" href="https://nestjs.com/">https://nestjs.com/</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/db04494e7d11.html" class="prev">上一篇</a><a href="/effa4f74d0af.html" class="next">下一篇</a></div><div id="gitalk-container"></div><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" async></script><script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js" async></script><script>var ds = document.createElement('link');
ds.rel = 'stylesheet';ds.async = true;
ds.href = 'https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
window.onload = function() {
  var gitalk = new Gitalk({
    clientID: '62e01f3aa3f140c5af8a',
    clientSecret: '8f02698609ba488706c5e67839f0bbf46861554f',
    repo: 'Tauleos.github.io',
    owner: 'Tauleos',
    admin: ['Tauleos'],
    id: md5(window.location.pathname),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })
  gitalk.render('gitalk-container');
}</script><div class="copyright"><p id="host_by"><span id="busuanzi_container_site_pv">&nbsp;本站总访问量 &nbsp;<span id="busuanzi_value_site_pv"><i class="fa fa-spinner"></i></span> 次,</span><span id="busanzi_container_site_uv">&nbsp;本站总访问人数 &nbsp;<span id="busuanzi_value_site_uv"><i class="fa fa-spinner"></i></span> 次.</span></p><p>© 2017 - 2024 created by <a href="https://tauleos.github.io">Tauleos</a>,Looking for better life and peace.</p><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script></div></footer></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body></html>