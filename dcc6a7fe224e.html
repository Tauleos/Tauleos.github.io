<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Chrome插件进阶 · Leo's Blog</title><meta name="description" content="Chrome插件进阶 - Tauleos"><meta name="google-site-verification" content="y-sRxe2Toq8nFRU8PiEYywkdUoWdk_UYysZDKbnM7Ck"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://tauleos.github.io/atom.xml" title="Leo's Blog"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Leo's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAGS</a></li><li class="nav-list-item"><a href="https://github.com/Tauleos" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Chrome插件进阶</h1><div class="post-info">2024年11月7日</div><div class="post-content"><p>上文我们了解了如何实现一个基础版的插件开发。当然，在现代开发模式下，我们肯定不能接受如此简陋的开发模式，那么我们如何进行下一步的优化呢，现在我们继续就如何使用组件库和热更新融合方面进行探索</p>
<span id="more"></span>

<h1 id="一、优化"><a href="#一、优化" class="headerlink" title="一、优化"></a>一、优化</h1><p>如今前端工具百花齐放。我们放着更好的工具不用岂不是浪费。能不能把我们的前端工具集成到chrome插件开发过程中，来实现更快捷的开发体验和更合适的ui展示呢？那我们就试着把vite+vue接入进来吧。</p>
<h2 id="目录调整"><a href="#目录调整" class="headerlink" title="目录调整"></a>目录调整</h2><ol>
<li>首先我们先快速生成vite与vue，TS的项目，</li>
<li>同时调整目录结构，将我们需要的content、popup等功能分开在不同的结构中。</li>
<li>安装组件库、pinia等工具；安装chrome-types 来对我们的api进行提示</li>
</ol>
<p>目录结构如下所示<br><img src="/images/extension/101730966937_.pic.jpg" alt="image.png"></p>
<h2 id="vite配置"><a href="#vite配置" class="headerlink" title="vite配置"></a>vite配置</h2><ol>
<li>通过<code>rollup-plugin-copy</code> 将静态资源（<code>manifest.json</code>、图标）等文件复制到打包后的目录中</li>
<li>通过设置vite的<code>build</code>选项,将<code>content</code>、<code>popup</code>等设置为打包的入口，并输出到manifest设置的目录中。<br>vite配置如下所示：<br><img src="/images/extension/111730966938_.pic.jpg" alt="image.png"></li>
</ol>
<p>打包之后，我们把打包后的文件夹扔到浏览器中，就可以达到我们上述第二步的目标。</p>
<blockquote>
<p>但是，如何能进一步方便我们的开发过程呢？在我们日常开发过程中的热加载可不可以也用上呢?</p>
</blockquote>
<h2 id="HMR"><a href="#HMR" class="headerlink" title="HMR"></a>HMR</h2><p>我们知道。webpack或者vite的dev环境下，工具为我们自动集成了HMR功能，可以使我们改动的代码自动更新到页面上。但是chrome插件与普通的浏览器页面不太一样。插件更新的话是需要在管理界面手动刷新插件，同时需要重新打开popup，整个插件的代码才会更新。所以有没有办法可以在插件内监听文件夹的变化呢？</p>
<h3 id="1、Chrome-runtime-getPackageDirectoryEntry"><a href="#1、Chrome-runtime-getPackageDirectoryEntry" class="headerlink" title="1、Chrome.runtime.getPackageDirectoryEntry"></a>1、Chrome.runtime.getPackageDirectoryEntry</h3><p>根据官方文档介绍。<code>getPackageDirectoryEntry</code> 可以获取文件夹内容并监听其变化。可是在V3版本中被限制了，只能在<code>popup</code>页面中使用，如果<code>popup</code>没有被点击弹出来的话，无法做到其他模块的热更新的。</p>
<h3 id="2、live-server-vite-watch-轮询"><a href="#2、live-server-vite-watch-轮询" class="headerlink" title="2、live-server + vite watch + 轮询"></a>2、live-server + vite watch + 轮询</h3><ol>
<li>通过<code>vite --watch build</code> 来自动编译我们的改动到dist文件。</li>
<li>通过 <code>live-server</code> 在本地启动一个静态资源服务器，保证所有的dist文件都可以热更新。</li>
<li>在 <code>background</code> 脚本中对所有的静态资源进行轮询，保存上一次的内容与这一次进行对比，发现内容有变化的话调用api进行更新<br>描述代码如下所示：</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fileList = [</span><br><span class="line">      <span class="string">&#x27;http://127.0.0.1:5501/dist/manifest.json&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;http://127.0.0.1:5501/dist/popup/popup.js&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;http://127.0.0.1:5501/dist/background/service-worker.js&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;http://127.0.0.1:5501/dist/content/content.js&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;http://127.0.0.1:5501/dist/contentPage/contentPage.js&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">fileObj</span>:  = &#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * reload 重新加载</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">reload</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      chrome.<span class="property">tabs</span>.<span class="title function_">query</span>(</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">active</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">currentWindow</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function">(<span class="params">tabs: chrome.tabs.Tab[]</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (tabs[<span class="number">0</span>]) &#123;</span><br><span class="line">            chrome.<span class="property">tabs</span>.<span class="title function_">reload</span>(tabs[<span class="number">0</span>].<span class="property">id</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          chrome.<span class="property">runtime</span>.<span class="title function_">reload</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 遍历监听的文件，通过请求获取文件内容，判断是否需要刷新</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">checkReloadPage</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      fileList.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">fetch</span>(item).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">text</span>())</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">files</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (fileObj[item] &amp;&amp; fileObj[item] !== files) &#123;</span><br><span class="line">            <span class="title function_">reload</span>()</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fileObj[item] = files</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">   <span class="title function_">checkReloadPage</span>()</span><br><span class="line"> &#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3、websocket"><a href="#3、websocket" class="headerlink" title="3、websocket"></a>3、websocket</h3><p>当然，我们可以参考webpack 和vite的 hmr模式，来自己实现一套基于websocket的hmr功能，来替代上述两个简单粗暴的方案。</p>
<ol>
<li>首先我们需要借用vite的插件能力，在vite启动和打包的时候，注入我们的ws代码，并在文件更新后通过ws通道发出需要更新的区域。</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;vite-plugin-crx-hmr&#x27;</span>,</span><br><span class="line">  <span class="attr">enforce</span>: <span class="string">&#x27;pre&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="title function_">configResolved</span>(<span class="params">config</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isDev) &#123;</span><br><span class="line">          <span class="keyword">if</span> (isBackground) &#123;</span><br><span class="line">              <span class="comment">// 启动 ws 服务端</span></span><br><span class="line">              <span class="title function_">startWebSocketServer</span>()</span><br><span class="line">          &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="comment">// 链接 ws 服务端</span></span><br><span class="line">              <span class="built_in">setTimeout</span>(connectWebSocketServer, <span class="number">2000</span>)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 打包完成后通知服务端(background)或客户端(page)代码更新</span></span><br><span class="line">  <span class="title function_">closeBundle</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;closeBundle&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isDev) &#123;</span><br><span class="line">          <span class="keyword">if</span> (isBackground) &#123;</span><br><span class="line">              <span class="title function_">handleServerChanged</span>()</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="title function_">handleClientChanged</span>(&#123; isPage &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在background中对ws服务进行链接，建立信号通道。并根据收到的信号量进行不同的reload操作</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">hmrWebSocketClient = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(</span><br><span class="line">  <span class="string">`ws://127.0.0.1:<span class="subst">$&#123;crxHmrPort&#125;</span>?mode=background`</span></span><br><span class="line">)</span><br><span class="line">hmrWebSocketClient.<span class="property">onopen</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;background initCrxHmr::&#x27;</span>, <span class="string">&#x27;onopen&#x27;</span>, event)</span><br><span class="line">&#125;</span><br><span class="line">hmrWebSocketClient.<span class="property">onclose</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;background initCrxHmr::&#x27;</span>, <span class="string">&#x27;onclose&#x27;</span>, event)</span><br><span class="line">  hmrWebSocketClient = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hmrWebSocketClient.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data &#125; = e</span><br><span class="line">  <span class="keyword">if</span> (data === <span class="string">&#x27;BACKGROUND_CHANGED&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">      <span class="string">&#x27;background initCrxHmr::&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;收到更新 background.js 消息，关闭 ws 并重新加载&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    hmrWebSocketClient?.<span class="title function_">close</span>()</span><br><span class="line">    chrome.<span class="property">runtime</span>.<span class="title function_">reload</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data === <span class="string">&#x27;IIFE_CHANGED&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">      <span class="string">&#x27;background initCrxHmr::&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;收到更新 iife 消息&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="title function_">reloadIife</span>(hmrWebSocketClient)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data === <span class="string">&#x27;PAGE_CHANGED&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;background initCrxHmr::&#x27;</span>, <span class="string">&#x27;收到更新 page 消息&#x27;</span>)</span><br><span class="line">    <span class="title function_">reloadPage</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>整体流程如下所示</li>
</ol>
<p><img src="/images/extension/121730966938_.pic.jpg" alt="分销.png"></p>
<h3 id="4、-crxjs-vite-plugin"><a href="#4、-crxjs-vite-plugin" class="headerlink" title="4、@crxjs/vite-plugin"></a>4、<a target="_blank" rel="noopener" href="https://crxjs.dev/vite-plugin">@crxjs/vite-plugin</a></h3><h3 id="5、rollup-plugin"><a href="#5、rollup-plugin" class="headerlink" title="5、rollup-plugin"></a>5、<a target="_blank" rel="noopener" href="https://www.extend-chrome.dev/rollup-plugin">rollup-plugin</a></h3><h1 id="四、成品展示"><a href="#四、成品展示" class="headerlink" title="四、成品展示"></a>四、成品展示</h1><h2 id="无依赖纯手撸版本"><a href="#无依赖纯手撸版本" class="headerlink" title="无依赖纯手撸版本"></a>无依赖纯手撸版本</h2><p><img src="/images/extension/131730966939_.pic.jpg" alt="image.png"></p>
<h2 id="工具集成版本（仅使用了部分组件库组件-pinia，主要是在开发中可以及时hmr）"><a href="#工具集成版本（仅使用了部分组件库组件-pinia，主要是在开发中可以及时hmr）" class="headerlink" title="工具集成版本（仅使用了部分组件库组件+pinia，主要是在开发中可以及时hmr）"></a>工具集成版本（仅使用了部分组件库组件+pinia，主要是在开发中可以及时hmr）</h2><p><img src="/images/extension/image.GIF" alt="动画.gif"></p>
<p>从wiki中解析出来后，可以直接复制到代码中进行业务开发。一想到不用挨个复制就美滋滋~😜🥂</p>
<h1 id="五、尾声"><a href="#五、尾声" class="headerlink" title="五、尾声"></a>五、尾声</h1><p>本文从实践的角度学习了chrome插件的基础知识与使用，同时深入介绍了和前端工具的集成方案，欢迎感兴趣的同事一起学习探讨。</p>
<hr>
<p> <strong>done~~</strong>  🏃‍♂️</p>
</div></article></div></main><footer><div class="paginator"><a href="/52dc035aff5e.html" class="next">下一篇</a></div><div id="gitalk-container"></div><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" async></script><script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js" async></script><script>var ds = document.createElement('link');
ds.rel = 'stylesheet';ds.async = true;
ds.href = 'https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
window.onload = function() {
  var gitalk = new Gitalk({
    clientID: '62e01f3aa3f140c5af8a',
    clientSecret: '8f02698609ba488706c5e67839f0bbf46861554f',
    repo: 'Tauleos.github.io',
    owner: 'Tauleos',
    admin: ['Tauleos'],
    id: md5(window.location.pathname),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })
  gitalk.render('gitalk-container');
}</script><div class="copyright"><p id="host_by"><span id="busuanzi_container_site_pv">&nbsp;本站总访问量 &nbsp;<span id="busuanzi_value_site_pv"><i class="fa fa-spinner"></i></span> 次,</span><span id="busanzi_container_site_uv">&nbsp;本站总访问人数 &nbsp;<span id="busuanzi_value_site_uv"><i class="fa fa-spinner"></i></span> 次.</span></p><p>© 2017 - 2024 created by <a href="https://tauleos.github.io">Tauleos</a>,Looking for better life and peace.</p><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script></div></footer></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body></html>